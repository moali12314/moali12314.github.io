// Интеграция с Telegram Web App — максимально возможное скрытие header
let isTelegram = false;
let tg;
let fullscreenRequested = false;

if (window.Telegram && window.Telegram.WebApp) {
    isTelegram = true;
    tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand(); // Расширяем по максимуму
    tg.disableClosingConfirmation();

    const tgVersion = tg.version || '0';
    const isAtLeast = (ver) => tg.isVersionAtLeast ? tg.isVersionAtLeast(ver) : parseFloat(tgVersion) >= parseFloat(ver);

    // Цвета для слияния
    tg.setBackgroundColor('#000000');
    if (isAtLeast('6.1')) {
        tg.setHeaderColor('#000000'); // Прямой чёрный — лучше сливается, чем 'bg_color'
    }
    if (isAtLeast('7.10')) {
        tg.setBottomBarColor('#000000'); // Нижняя плашка тоже чёрная
    }

    tg.MainButton.hide();
    if (tg.SecondaryButton && isAtLeast('7.10')) {
        tg.SecondaryButton.hide();
    }

    if (isAtLeast('7.7')) {
        tg.disableVerticalSwipes(); // Запрещаем свайп вниз
    }

    // Функция запроса fullscreen
    const tryRequestFullscreen = () => {
        if (fullscreenRequested) return;
        fullscreenRequested = true;

        if (isAtLeast('8.0') && tg.requestFullscreen) {
            tg.requestFullscreen()
                .then(() => {
                    console.log("Fullscreen включён через Telegram API");
                    tg.expand(); // Повторно expand
                    // В fullscreen header прозрачный — идеально для игры
                })
                .catch(err => {
                    console.log("Fullscreen Telegram не удался:", err);
                    // Fallback браузерный
                    if (document.documentElement.requestFullscreen) {
                        document.documentElement.requestFullscreen({ navigationUI: "hide" }).catch(() => {});
                    }
                });
        } else {
            // Старые версии — только браузерный fullscreen
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen({ navigationUI: "hide" }).catch(() => {});
            }
        }
    };

    // Запрашиваем fullscreen СРАЗУ
    tryRequestFullscreen();

    // Слушаем события
    if (isAtLeast('8.0')) {
        tg.onEvent('fullscreenChanged', () => {
            console.log("Fullscreen статус:", tg.isFullscreen);
            if (!tg.isFullscreen) {
                tryRequestFullscreen(); // Пытаемся вернуться
            }
        });
        tg.onEvent('fullscreenFailed', (error) => {
            console.log("Fullscreen ошибка:", error);
        });
    }

    // Для безопасных зон (notch, status bar) — добавь отступы к canvas
    if (isAtLeast('8.0')) {
        const updateSafeArea = () => {
            const insetTop = tg.safeAreaInset?.top || 0;
            canvas.style.paddingTop = `${insetTop}px`;
            canvas.style.height = `calc(100% - ${insetTop}px)`;
            // Можно подвинуть и другие элементы, если нужно
        };
        updateSafeArea();
        tg.onEvent('safeAreaChanged', updateSafeArea);
    }

    // На любое касание/клик — повторно fullscreen (на всякий случай)
    const requestOnInteraction = () => {
        if (!fullscreenRequested) tryRequestFullscreen();
    };
    canvas.addEventListener('touchstart', requestOnInteraction, { once: true });
    canvas.addEventListener('click', requestOnInteraction, { once: true });
} else {
    // Не Telegram — браузерный fullscreen
    if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen({ navigationUI: "hide" }).catch(() => {});
    }
}
